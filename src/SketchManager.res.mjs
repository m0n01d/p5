// Generated by ReScript, PLEASE EDIT WITH CARE

import P5 from "p5";
import * as Core__Int from "@rescript/core/src/Core__Int.res.mjs";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.res.mjs";
import * as PlotterFrame from "./PlotterFrame.res.mjs";

var state = {
  contents: {
    currentP5: undefined,
    sketches: [],
    currentIndex: 0
  }
};

function removeCurrentSketch() {
  console.log("removeCurrentSketch called");
  var sketchDiv = document.getElementById("sketch");
  if (sketchDiv == null) {
    console.log("Sketch container not found during removal");
  } else {
    console.log("Clearing sketch container innerHTML");
    sketchDiv.innerHTML = "";
  }
  var p5 = state.contents.currentP5;
  if (p5 !== undefined) {
    console.log("Calling p5.remove()");
    Caml_option.valFromOption(p5).remove();
    var init = state.contents;
    state.contents = {
      currentP5: undefined,
      sketches: init.sketches,
      currentIndex: init.currentIndex
    };
    return ;
  }
  console.log("No current p5 instance to remove");
}

function switchToSketch(index) {
  console.log("=== Switching to sketch index: " + index.toString() + " ===");
  removeCurrentSketch();
  ((setTimeout(() => {}, 10)));
  var config = state.contents.sketches[index];
  if (config !== undefined) {
    console.log("Creating new sketch: " + config.name);
    var sketchFn = config.createFn();
    var p5Instance = new P5(sketchFn, "sketch");
    console.log("New sketch attached to container");
    var init = state.contents;
    state.contents = {
      currentP5: Caml_option.some(p5Instance),
      sketches: init.sketches,
      currentIndex: index
    };
    console.log("=== Sketch switch complete ===");
    return ;
  }
  console.log("Sketch at index " + index.toString() + " not found");
}

function createSketchSelector() {
  var controlsDiv = document.getElementById("sketch-controls");
  if (controlsDiv == null) {
    console.log("Controls container not found");
    return ;
  }
  controlsDiv.innerHTML = "";
  var label = document.createElement("label");
  label.textContent = "Select Sketch: ";
  label.className = "sketch-label";
  controlsDiv.appendChild(label);
  var select = document.createElement("select");
  select.className = "sketch-selector";
  state.contents.sketches.forEach(function (sketch, index) {
        var option = document.createElement("option");
        option.value = index.toString();
        option.textContent = sketch.name;
        select.appendChild(option);
      });
  select.value = state.contents.currentIndex.toString();
  select.addEventListener("change", (function () {
          var selectedIndex = Core__Option.getOr(Core__Int.fromString(select.value, undefined), 0);
          console.log("Dropdown changed to index: " + selectedIndex.toString());
          switchToSketch(selectedIndex);
        }));
  controlsDiv.appendChild(select);
  console.log("Sketch selector created");
}

function exportCurrentSketch() {
  var p5 = state.contents.currentP5;
  if (p5 !== undefined) {
    var p5$1 = Caml_option.valFromOption(p5);
    var formatSelect = document.getElementById("export-format");
    if (formatSelect == null) {
      console.log("Export format selector not found");
      return ;
    }
    var format = formatSelect.value;
    console.log("Exporting current sketch as " + format);
    var canvas = p5$1.canvas;
    var timestamp = (new Date().toISOString());
    var filename = timestamp + "." + format;
    if (format === "png") {
      var dataUrl = canvas.toDataURL("image/png", 1.0);
      var link = document.createElement("a");
      link.href = dataUrl;
      link.download = filename;
      var linkStyle = link.style;
      linkStyle.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return ;
    }
    if (format !== "svg") {
      return ;
    }
    var dataUrl$1 = canvas.toDataURL("image/png", 1.0);
    var widthPx = p5$1.width;
    var heightPx = p5$1.height;
    var paperSize = PlotterFrame.getCurrentPaperSize();
    var widthMm = paperSize.widthMm.toString();
    var heightMm = paperSize.heightMm.toString();
    var svgContent = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"\n     width=\"" + widthMm + "mm\" height=\"" + heightMm + "mm\"\n     viewBox=\"0 0 " + widthPx.toString() + " " + heightPx.toString() + "\">\n  <image width=\"" + widthPx.toString() + "\" height=\"" + heightPx.toString() + "\" xlink:href=\"" + dataUrl$1 + "\"/>\n</svg>";
    var blob = ((content) => new Blob([content], {type: 'image/svg+xml'}))(svgContent);
    var url = ((b) => URL.createObjectURL(b))(blob);
    var link$1 = document.createElement("a");
    link$1.href = url;
    link$1.download = filename;
    var linkStyle$1 = link$1.style;
    linkStyle$1.display = "none";
    document.body.appendChild(link$1);
    link$1.click();
    document.body.removeChild(link$1);
    return ((u) => URL.revokeObjectURL(u))(url);
  }
  console.log("No sketch to export");
}

function registerSketch(name, createFn) {
  var init = state.contents;
  state.contents = {
    currentP5: init.currentP5,
    sketches: state.contents.sketches.concat([{
            name: name,
            createFn: createFn
          }]),
    currentIndex: init.currentIndex
  };
  console.log("Registered sketch: " + name);
}

function init() {
  console.log("Initializing Sketch Manager...");
  createSketchSelector();
  var exportBtn = document.getElementById("export-btn");
  if (exportBtn == null) {
    console.log("Export button not found");
  } else {
    exportBtn.addEventListener("click", (function () {
            exportCurrentSketch();
          }));
    console.log("Export button initialized");
  }
  if (state.contents.sketches.length > 0) {
    switchToSketch(0);
  }
  console.log("Sketch Manager initialized");
}

export {
  state ,
  removeCurrentSketch ,
  switchToSketch ,
  createSketchSelector ,
  exportCurrentSketch ,
  registerSketch ,
  init ,
}
/* p5 Not a pure module */
